# ИИ-ассистент «Ким»

Персональный ассистент в двух режимах:
- Локальный голосовой ассистент для Windows
- Приватный Telegram-бот

## Структура проекта

```
/src
  /kim_core      - ядро ассистента (конфиг, LLM, промпты, логирование)
  /kim_voice     - голосовая часть (hotword, STT, TTS)
  /kim_telegram  - Telegram-бот
  /kim_scheduler - планировщик (Stage 2)
  /kim_desktop   - взаимодействие с ПК (Stage 2)
  /kim_settings_panel - панель настроек (Stage 2)
/tests           - тесты
/scripts         - утилиты
/docs            - документация
```

## Установка

1. Установите Python 3.10+
2. Скопируйте `.env.example` в `.env` и заполните переменные
3. Установите зависимости: `pip install -r requirements.txt`

## Конфигурация

Конфигурация приложения загружается из файла `.env` в корне проекта.

### Основные переменные окружения

- `MODE` — режим работы (`dev` или `prod`). По умолчанию: `dev`
- `LOG_LEVEL` — уровень логирования (`DEBUG`, `INFO`, `WARNING`, `ERROR`). По умолчанию: `INFO`
- `OPENROUTER_API_KEY` — API-ключ для OpenRouter (обязателен в режиме `prod`)
- `BOT_TOKEN` — токен Telegram-бота (обязателен в режиме `prod`)
- `MODEL_FAST` — быстрая модель LLM. По умолчанию: `openai/gpt-3.5-turbo`
- `MODEL_SMART` — умная модель LLM для сложных задач. По умолчанию: `openai/gpt-4-turbo`
- `TOKEN_BUDGET_DAILY` — дневной лимит токенов. По умолчанию: `50000`
- `LOCAL_ONLY` — режим только локально (`0` или `1`). Если `1`, ассистент не обращается к LLM и даёт только локальные голосовые ответы. По умолчанию: `0`
- `CPU_WARN` — порог предупреждения для загрузки CPU (в процентах). По умолчанию: `85`
- `RAM_WARN` — порог предупреждения для использования RAM (в процентах). По умолчанию: `90`
- `DISK_WARN` — порог предупреждения для использования диска (в процентах). По умолчанию: `90`
- `TEMP_WARN` — порог предупреждения для температуры (в градусах Цельсия). По умолчанию: не задан
- `DIAGNOSTICS_INTERVAL_SECONDS` — интервал проверки диагностики в секундах. По умолчанию: `60`
- `ALERTS_CHAT_ID` — ID чата/пользователя Telegram для отправки уведомлений о проблемах системы. По умолчанию: не задан

В режиме `prod` приложение проверяет наличие обязательных переменных (`OPENROUTER_API_KEY` и `BOT_TOKEN`) и выдаёт ошибку при их отсутствии.

## Интеграция с OpenRouter

Проект использует OpenRouter API для работы с LLM-моделями через два основных компонента:

### OpenRouterClient

Асинхронный клиент для взаимодействия с OpenRouter API. Обрабатывает запросы, ошибки сети и парсит ответы с информацией об использовании токенов.

### LLMRouter

Маршрутизатор моделей, который:

- **Автоматически выбирает модель** на основе контекста запроса:
  - По умолчанию использует быструю модель (`MODEL_FAST`)
  - Переключается на умную модель (`MODEL_SMART`) при обнаружении триггеров

- **Управляет дневным лимитом токенов** (`TOKEN_BUDGET_DAILY`):
  - Отслеживает использование токенов за день
  - Автоматически сбрасывает счётчик при смене даты
  - Блокирует запросы при превышении лимита

### Триггеры для умной модели

Для переключения на более мощную модель используйте в запросе одну из фраз:

- «реши это GPT-5»
- «режим качества»
- «нужен максимальный анализ»

Триггерные фразы автоматически удаляются из сообщения перед отправкой в LLM.

## Запуск Telegram-бота

### Подготовка

1. Создайте файл `.env` на основе `.env.example`:
   ```bash
   cp .env.example .env
   ```

2. Заполните обязательные переменные в `.env`:
   - `BOT_TOKEN` — токен вашего Telegram-бота (получите у [@BotFather](https://t.me/BotFather))
   - `OPENROUTER_API_KEY` — ваш API-ключ OpenRouter

3. Установите зависимости (если ещё не установлены):
   ```bash
   pip install -r requirements.txt
   ```

### Запуск

Запустите бота командой:
```bash
python run_bot.py
```

Или альтернативный способ:
```bash
cd src && python -m kim_telegram.main
```

### Использование

После запуска бот будет отвечать на сообщения в Telegram:

- **`/start`** — приветственное сообщение от Ким
- **`/help`** — показать список всех доступных команд
- **`/reset`** — очистка контекста диалога (начать разговор заново)
- **`/myid`** — показывает ваш Chat ID (для настройки уведомлений диагностики)
- **Обычное сообщение** — отправляется в LLM, учитывается контекст всей переписки

Бот автоматически:
- Сохраняет контекст диалога для каждого пользователя
- Выбирает модель (быструю или умную) на основе триггеров
- Отслеживает дневной лимит токенов
- Обрабатывает ошибки и уведомляет пользователя

### Примеры триггеров для умной модели

Для переключения на более мощную модель используйте в сообщении:
- «реши это GPT-5»
- «режим качества»
- «нужен максимальный анализ»

## Голосовой ассистент (локально, Windows)

Голосовой ассистент работает локально на Windows и активируется по ключевому слову «Ким».

### Требования

1. **Модель Vosk** для распознавания речи (см. раздел «Установка модели Vosk» ниже)
2. **Микрофон** должен быть подключён и настроен в Windows
3. **API ключ OpenRouter** для работы с LLM:
   - Укажите `OPENROUTER_API_KEY` в файле `.env`
   - Убедитесь, что на балансе есть средства

### Установка модели Vosk

**Важно:** Для работы голосового ассистента необходимо установить модель Vosk для распознавания речи.

1. **Скачайте модель Vosk:**
   - Перейдите на https://alphacephei.com/vosk/models
   - Для русского языка рекомендуем скачать одну из моделей:
     - `vosk-model-small-ru-0.22` (≈45 МБ) — быстрая, но менее точная
     - `vosk-model-ru-0.42` (≈1.8 ГБ) — более точная (рекомендуется)
     - `vosk-model-ru-0.22` (≈1.5 ГБ) — хороший баланс

2. **Распакуйте модель:**
   - Создайте папку `models` в корне проекта (если её нет)
   - Распакуйте скачанную модель так, чтобы структура была:
     ```
     models/
       vosk-ru/
         am/
         graph/
         ivector/
         ...
     ```
   - Имя папки `vosk-ru` может быть любым, но должно соответствовать пути в `.env`

3. **Настройте путь в `.env`:**
   ```env
   VOSK_MODEL_PATH=models/vosk-ru
   ```
   
   Или укажите полный путь к модели, если она находится в другом месте:
   ```env
   VOSK_MODEL_PATH=C:/path/to/vosk-model-ru-0.42
   ```

4. **Проверьте установку:**
   ```bash
   python scripts/check_voice_system.py
   ```
   
   Скрипт покажет, найдена ли модель и корректна ли её структура.

### Настройка

1. Убедитесь, что установлены все зависимости:
   ```bash
   pip install -r requirements.txt
   ```

### Запуск

#### Вариант 1: Использование PowerShell скрипта (рекомендуется для Windows)

Для корректного отображения русских символов в логах используйте готовый скрипт:

```powershell
.\run_voice_utf8.ps1
```

#### Вариант 2: Запуск через Python скрипт с настройкой кодировки

Если используете PowerShell, установите кодировку UTF-8 перед запуском:

```powershell
$OutputEncoding = [System.Text.Encoding]::UTF8
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
chcp 65001 | Out-Null
python run_voice.py
```

Или используйте стандартный скрипт:

```bash
python run_voice.py
```

#### Вариант 3: Запуск через модуль Python

```bash
python -m src.kim_voice.main
```

**Примечание:** Для корректного отображения русских символов в Windows PowerShell рекомендуется использовать Вариант 1 или Вариант 2.

### Диагностика Vosk

Если hotword «Ким» не срабатывает или вы подозреваете проблемы с распознаванием речи,
можно отдельно протестировать связку **Vosk + микрофон** без hotword-логики.

Запустите тестовый скрипт:

```bash
python -m scripts.test_vosk_mic
```

При запуске:

- загружается модель Vosk, указанная в `VOSK_MODEL_PATH` или `models/vosk-ru`,
- открывается микрофон,
- в течение ~15 секунд аудио с микрофона передаётся в Vosk.

Ожидаемое поведение:

- при разговоре в микрофон в **stdout** и в логах вы увидите:
  - строки вида `[PARTIAL] ...` — промежуточные (partial) результаты Vosk,
  - строки вида `[FINAL] ...` — финальные (final) результаты Vosk.
- если partial/final результатов нет вообще — проблема, скорее всего, в:
  - доступе к микрофону,
  - установке/пути к модели Vosk,
  - окружении аудиодрайверов.

Этот тест позволяет быстро отделить проблемы Vosk/микрофона от логики hotword и ассистента.

### Голосовой диалог с LLM

После активации по ключевому слову «Ким» ассистент:

1. **Отвечает голосом:** «Да, слушаю.»
2. **Слушает вопрос** пользователя через микрофон (с автоматическими повторами при неудачном распознавании)
3. **Подтверждает распознанную фразу:** «Вы сказали: [фраза]. Верно?»
4. **Слушает подтверждение** пользователя («да»/«нет»)
5. **Если пользователь сказал «нет»:** просит повторить фразу заново
6. **После подтверждения:**
   - Если `LOCAL_ONLY=0`: отправляет вопрос в LLM через OpenRouter
   - Если `LOCAL_ONLY=1`: даёт локальный ответ (без обращения к интернету)
7. **Озвучивает ответ** голосом (TTS)

**Пример использования:**
- Пользователь: «Ким» (hotword активирован)
- Ассистент: «Да, слушаю.» (голосом)
- Пользователь: «Расскажи кратко новости за сегодня» (голосом)
- Ассистент: «Вы сказали: Расскажи кратко новости за сегодня. Верно?»
- Пользователь: «Да» (или просто молчание)
- Ассистент: Озвучивает ответ, полученный от LLM

### Поведение

После запуска ассистент:
- Начинает прослушивать микрофон для поиска ключевого слова «Ким»
- При обнаружении слова «Ким»:
  - Отвечает голосом: «Да, слушаю.»
  - Переходит в режим прослушивания вопроса
  - При неудачном распознавании делает до 2 повторных попыток
  - После распознавания подтверждает фразу голосом и спрашивает, верно ли она поняла
  - При подтверждении отправляет вопрос в LLM (если не включён режим `LOCAL_ONLY`)
  - Озвучивает ответ от LLM или локальный ответ
- Использует антидребезг (не срабатывает чаще раза в 1.2 секунды)

Для остановки нажмите `Ctrl+C`.

### Улучшения UX

#### Подтверждение команды

Ким повторяет распознанную фразу и спрашивает, верно ли она поняла. Это помогает:
- Убедиться, что команда распознана правильно
- Исправить ошибку распознавания, если что-то пошло не так

**Пример:**
- Пользователь: «Какой сегодня день?»
- Ассистент: «Вы сказали: Какой сегодня день? Верно?»
- Пользователь: «Да» → продолжает выполнение
- Пользователь: «Нет» → просит повторить

#### Повторы

При плохом распознавании речи (тишина, неразборчиво) Ким делает до 2 автоматических повторных попыток распознать фразу. Это повышает надёжность работы в шумной обстановке.

**Пример:**
- Попытка 1: ничего не распознано
- Попытка 2: ничего не распознано
- Попытка 3: фраза распознана успешно

Если все попытки неудачны, Ким сообщает: «Не расслышала, повторите позже.»

#### Режим только локально

Если в `.env` установлено `LOCAL_ONLY=1`, Ким работает без обращения к LLM и даёт только локальные ответы:

- Приветствие: «Привет! Сейчас я работаю в локальном режиме и не обращаюсь к интернету.»
- Запрос времени: сообщает текущее время (если в фразе есть слова «время», «который час»)
- Остальные запросы: «Сейчас включён режим только локально, я не обращаюсь к ИИ-модели.»

Этот режим полезен для:
- Тестирования голосового интерфейса без затрат на API
- Работы в условиях отсутствия интернета
- Повышения приватности (данные не отправляются в облако)

### Настройка TTS

Параметры голоса можно изменить в коде `src/kim_voice/tts/voice.py`:
- Скорость речи (по умолчанию: 170 слов/минуту)
- Громкость (по умолчанию: 1.0)
- Выбор женского голоса выполняется автоматически, если доступен

### Настройка качества распознавания

Система использует фильтрацию для повышения качества распознавания речи и снижения ложных срабатываний hotword.

**Важно:** Hotword и STT — это разные этапы работы ассистента:

- **Hotword (детекция «Ким»)** — работает постоянно, ищет короткое слово "Ким" (3 символа) и имеет свои настройки фильтрации (`min_chars_in_utterance = 3`)
- **STT (распознавание вопроса)** — используется ПОСЛЕ активации hotword для распознавания полного вопроса пользователя (обычно длиннее 5 символов)
- **STT (подтверждение)** — используется для коротких ответов "да"/"нет" и имеет специальные мягкие критерии

Поэтому параметр `min_phrase_chars = 5` для STT не конфликтует с hotword "Ким" (3 символа) — это разные этапы работы системы.

#### STT (Распознавание речи)

Для улучшения качества распознавания применяются следующие фильтры:

- **Минимальная длина фразы** (`min_phrase_chars = 5`) — слишком короткие фразы (менее 5 символов) отклоняются как некачественные. Это применяется для распознавания вопросов пользователя.
- **Минимальная средняя уверенность** (`min_avg_confidence = 0.6`) — фразы с низкой уверенностью распознавания (средняя уверенность по словам < 0.6) отклоняются

**Для коротких подтверждений** ("да"/"нет") используется специальный метод `listen_once_for_confirmation()` с более мягкими критериями:
- Минимальная длина: 2 символа (подходит для "да", "нет")
- Минимальная уверенность: 0.5 (ниже, чем для обычных фраз)
- Более короткий таймаут тишины: 1 секунда (вместо 1.5)

Это позволяет корректно распознавать короткие ответы пользователя.

Эти параметры настраиваются в `STTConfig` в файле `src/kim_voice/stt/speech_to_text.py`:

```python
@dataclass
class STTConfig:
    min_phrase_chars: int = 5  # минимальная длина фразы в символах
    min_avg_confidence: float = 0.6  # минимальная средняя уверенность
    debug_log_words: bool = False  # логирование слов с уверенностью
```

Если в вашей среде много шума, можно:
- Увеличить `min_avg_confidence` (например, до `0.7` или `0.8`) для более строгой фильтрации
- Увеличить `min_phrase_chars` (например, до `7`), чтобы игнорировать очень короткие фразы

#### Hotword (Ключевое слово «Ким»)

Для снижения ложных срабатываний hotword применяются:

- **Строгое совпадение слова** (`require_strict_word_match = True`) — hotword срабатывает только если найдено отдельное слово "ким", а не подстрока
- **Минимальная длина фразы** (`min_chars_in_utterance = 3`) — слишком короткие фразы игнорируются
- **Минимальная средняя уверенность** (`min_hotword_confidence = 0.7`) — низкая уверенность распознавания приводит к игнорированию

Эти параметры настраиваются в `HotwordConfig` в файле `src/kim_voice/hotword/kim_hotword.py`:

```python
@dataclass
class HotwordConfig:
    min_hotword_confidence: float = 0.7  # минимальная средняя уверенность
    require_strict_word_match: bool = True  # строгое совпадение слова
    min_chars_in_utterance: int = 3  # минимальная длина фразы
```

Если hotword срабатывает слишком часто:
- Увеличьте `min_hotword_confidence` (например, до `0.8` или `0.85`)
- Убедитесь, что `require_strict_word_match = True` включено

Если hotword не срабатывает:
- Незначительно снизьте `min_hotword_confidence` (например, до `0.65`)
- Проверьте, что микрофон работает корректно

### Отладка

Для проверки работы:
1. Убедитесь, что модель Vosk загружена (проверьте логи при запуске)
2. Проверьте, что микрофон работает (Windows → Параметры → Система → Звук)
3. В логах будут видны все распознанные фразы и срабатывания hotword

## Диагностика ПК и оповещения

Ассистент «Ким» может отслеживать состояние вашего компьютера и уведомлять о проблемах с ресурсами системы.

### Собираемые метрики

Сервис диагностики собирает следующие метрики:

- **CPU (процессор)** — процент использования процессора
- **RAM (память)** — процент использования оперативной памяти
- **Диск** — процент использования дискового пространства
- **Температура** — температура процессора (если доступна на вашей платформе)

### Пороги предупреждений

По умолчанию предупреждения отправляются при:

- Загрузка CPU ≥ 85%
- Использование RAM ≥ 90%
- Использование диска ≥ 90%
- Температура — настраивается вручную (по умолчанию не задана)

Вы можете настроить пороги в файле `.env`:

```env
CPU_WARN=85
RAM_WARN=90
DISK_WARN=90
TEMP_WARN=80
```

Если порог не задан (например, `TEMP_WARN=`), предупреждения по этой метрике отправляться не будут.

### Настройка уведомлений

Для получения уведомлений в Telegram необходимо указать:

1. **`ALERTS_CHAT_ID`** — ID вашего чата/пользователя в Telegram

   **Самый простой способ получить ID:**
   
   - Запустите вашего бота (если ещё не запущен): `python run_bot.py`
   - Отправьте боту команду: ` /myid`
   - Бот вернёт ваш Chat ID (например, `123456789`)
   - Добавьте этот ID в файл `.env`:
     ```env
     ALERTS_CHAT_ID=123456789
     ```

   **Альтернативные способы:**
   
   - Через бота [@userinfobot](https://t.me/userinfobot): напишите `/start`, бот вернёт ваш ID
   - Через бота [@RawDataBot](https://t.me/RawDataBot): отправьте сообщение, бот вернёт JSON с ID
   - Через скрипт: запустите `python scripts/get_chat_id.py` для подробных инструкций

2. **`BOT_TOKEN`** — токен вашего Telegram-бота (должен быть уже указан)

3. **`DIAGNOSTICS_INTERVAL_SECONDS`** — интервал проверки в секундах (по умолчанию: 60)

```env
ALERTS_CHAT_ID=123456789
DIAGNOSTICS_INTERVAL_SECONDS=60
```

### Запуск сервиса диагностики

Запустите сервис диагностики командой:

```bash
python -m src.kim_scheduler.diagnostics_watcher
```

Или альтернативный способ:

```bash
cd src && python -m kim_scheduler.diagnostics_watcher
```

### Поведение сервиса

После запуска сервис:

1. **Проверяет метрики** каждые N секунд (по умолчанию 60)
2. **Сравнивает** значения с порогами
3. **При превышении порогов:**
   - Отправляет уведомление в Telegram с подробностями проблем
   - Если голосовой ассистент запущен локально (Windows), произносит голосовое предупреждение: *"Внимание, обнаружены проблемы с ресурсами компьютера. Я отправила подробности в Telegram."*

**Пример уведомления в Telegram:**

```
⚠️ Диагностика ПК: обнаружены проблемы:

• Высокая загрузка CPU: 92.5% (порог: 85%)
• Мало свободной оперативной памяти: 95.2% используется (порог: 90%)
```

### Голосовые уведомления

Голосовые уведомления доступны автоматически, если:

- Сервис запущен на Windows
- Модуль `kim_voice` доступен
- Синтезатор речи (TTS) инициализирован успешно

Если голосовые уведомления недоступны, сервис продолжит работу и будет отправлять только Telegram-уведомления.

### Особенности температуры

Поддержка температуры зависит от:

- **Платформы** (Windows/Linux/macOS)
- **Доступности сенсоров** в системе
- **Возможностей библиотеки psutil**

Если температура недоступна, сервис продолжит работу, собирая остальные метрики.

### Остановка сервиса

Для остановки сервиса нажмите `Ctrl+C`. Сервис корректно завершит работу и закроет все ресурсы.