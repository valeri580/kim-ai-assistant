# ИИ-ассистент «Ким»

**Ким** — персональный ассистент для Windows, работающий в двух режимах: локальный голосовой ассистент с активацией по hotword «Ким» и приватный Telegram-бот. Ассистент использует LLM для ответов на вопросы, поддерживает голосовое взаимодействие, управляет напоминаниями, выполняет поиск в интернете, работает с файлами и отслеживает состояние компьютера.

## Системные требования

- **ОС:** Windows 10/11
- **Python:** 3.10 или выше
- **Микрофон:** для работы голосового режима
- **Интернет:** для работы с LLM и Telegram (опционально, есть офлайн-режим)

## Установка (Windows)

### 1. Python

Установите Python 3.10+ с официального сайта: https://www.python.org/downloads/

При установке отметьте опцию **«Add Python to PATH»**.

### 2. Vosk модель

Для работы голосового ассистента необходимо скачать модель Vosk:

1. Перейдите на https://alphacephei.com/vosk/models
2. Скачайте модель для русского языка (рекомендуется `vosk-model-ru-0.42`, ~1.8 ГБ)
3. Распакуйте модель в папку `models/vosk-ru` в корне проекта
4. Убедитесь, что структура папки содержит файлы `am/`, `graph/`, `ivector/`

### 3. Ключи

Секреты (API-ключи и токены) хранятся в Windows Credential Manager, а не в файлах.

**Сохранение секретов:**

```bash
python scripts/set_secrets.py
```

Скрипт попросит ввести:
- **OpenRouter API ключ** — получите на https://openrouter.ai
- **Telegram Bot Token** — получите у [@BotFather](https://t.me/BotFather)

### 4. Файлы

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

2. Создайте файл `.env` в корне проекта:
   ```env
   MODE=dev
   LOG_LEVEL=INFO
   VOSK_MODEL_PATH=models/vosk-ru
   ALERTS_CHAT_ID=123456789
   ```

3. Получите Chat ID для уведомлений:
   - Запустите бота: `make bot`
   - Отправьте команду `/myid`
   - Добавьте полученный ID в `.env`: `ALERTS_CHAT_ID=ваш_id`

## Запуск

### Голосовой ассистент

```bash
make voice
```

или

```bash
python -m scripts.run_voice_assistant
```

После запуска произнесите **«Ким»** для активации. Ассистент ответит голосом и будет готов к диалогу.

### Telegram-бот

```bash
make bot
```

или

```bash
python -m scripts.run_telegram_bot
```

После запуска бот будет отвечать на сообщения в Telegram. Используйте команду `/start` для начала работы.

### Панель настроек

```bash
make settings
```

или

```bash
python -m src.kim_settings_panel.api
```

Откройте в браузере: **http://localhost:8000**

Панель позволяет настраивать режимы работы, профили качества, пороги диагностики и другие параметры без перезапуска компонентов.

### Диагностика

```bash
make diag
```

или

```bash
python -m scripts.run_diagnostics_service
```

Сервис отслеживает состояние компьютера (CPU, RAM, диск, температура) и отправляет уведомления в Telegram при превышении порогов.

### Календарь

Воркер напоминаний запускается отдельно:

```bash
python -m src.kim_scheduler.reminders.worker
```

Воркер проверяет запланированные напоминания и отправляет уведомления в Telegram.

## Сценарии

Панель настроек предоставляет три готовых сценария для быстрой настройки:

### 1. Домашний голосовой ассистент (`home_voice_assistant`)

- **Режим:** `voice_assistant`
- **Профиль:** `quality`
- **Параметры:**
  - `local_only = False` — используется онлайн LLM
  - `enable_voice_assistant = True` — голосовой режим включён
  - `enable_web_search = True` — веб-поиск включён
  - `token_budget_daily = 200000` — высокий лимит токенов
- **Назначение:** Максимальные возможности для домашнего использования с упором на качество ответов и комфорт взаимодействия.

### 2. Лёгкий Telegram-помощник (`light_telegram_helper`)

- **Режим:** `telegram_only`
- **Профиль:** `performance`
- **Параметры:**
  - `local_only = False` — используется онлайн LLM
  - `enable_voice_assistant = False` — голосовой режим отключён
  - `enable_web_search = False` — веб-поиск отключён
  - `token_budget_daily = 20000` — минимальный лимит токенов для экономии
- **Назначение:** Экономный режим для работы только через Telegram-бот без голосового интерфейса.

### 3. Полностью офлайн настольный ассистент (`offline_desktop_assistant`)

- **Режим:** `offline`
- **Профиль:** `balanced`
- **Параметры:**
  - `local_only = True` — полностью локальный режим без LLM
  - `enable_voice_assistant = True` — голосовой режим включён
  - `enable_web_search = False` — веб-поиск отключён
  - Модели LLM очищены (не используются)
  - Лимит токенов очищен (не используется)
- **Назначение:** Максимальная приватность, работа только с локальными функциями (напоминания, диагностика системы, работа с файлами).

**Использование сценариев:**

Сценарий можно выбрать одним нажатием кнопки в панели настроек. После выбора сценария все параметры формы обновляются моментально, отражая настройки выбранного сценария. После применения сценария все параметры можно дополнительно настроить вручную — сценарий применяется как основа, поверх которой можно делать индивидуальные правки.

## Команды Telegram

### Основные команды

- `/start` — приветственное сообщение
- `/help` — список всех доступных команд
- `/reset` — очистить контекст диалога
- `/myid` — показать ваш Chat ID

### Напоминания

- `/remind YYYY-MM-DD HH:MM Текст [минут_до]` — создать напоминание
  - Пример: `/remind 2025-12-10 15:00 созвон с клиентом 30`
- `/reminders` — показать список напоминаний
- `/remind_delete <id>` — удалить напоминание

### Веб-поиск

- `/web <запрос>` — поиск в интернете
  - Пример: `/web погода в Москве`

### Работа с файлами

- `/file_summary <путь>` — резюме файла через LLM
- `/file_put <путь> <alias>` — копировать файл в директорию (downloads, desktop, documents)
- `/file_move <путь> <alias>` — переместить файл
- `/file_list <alias> [pattern]` — список файлов в директории

### Обычные сообщения

Просто отправьте текст — Ким ответит, учитывая контекст всего разговора.

**Совет:** Используйте в запросе фразы «режим качества» или «реши это GPT-5» для переключения на более мощную модель.

## Голосовые команды

### Основные команды

После активации (произнесите **«Ким»**) доступны следующие команды:

- **Обычные вопросы:** «Ким, какой сегодня день?», «Ким, расскажи новости»
- **Веб-поиск:** «Ким, найди погоду в Москве», «Ким, поищи новости про ИИ»
- **Напоминания:** 
  - «Ким, напомни через 10 минут выпить воды»
  - «Ким, напомни через час позвонить маме»
  - «Ким, напомни через полчаса проверить почту»
- **Работа с файлами:**
  - «Ким, положи файл в документы»
  - «Ким, перемести то что я скачал на рабочий стол»
- **Отправка в Telegram:** «Ким, отправь сообщение в телеграм: Я закончил работу»

### Особенности

- Подтверждение фразы запрашивается только при низкой уверенности или длинных фразах
- При неудачном распознавании ассистент делает до 2 повторных попыток
- В режиме `local_only` ассистент работает без обращения к LLM

## FAQ

### Проблемы с микрофоном

**Микрофон не работает или не распознаётся:**

1. Проверьте настройки микрофона в Windows (Параметры → Система → Звук)
2. Убедитесь, что микрофон включён в настройках приватности Windows
3. Запустите диагностику: `python scripts/diagnose_microphone.py`
4. Укажите индекс устройства в `.env`: `MIC_DEVICE_INDEX=1` (узнать индекс: `python -c "import sounddevice as sd; print(sd.query_devices())"`)

**Ошибка 247 (буферизация):**

- Увеличьте `MIC_CHUNK_SIZE` в `.env` (например, до 8000)
- Проверьте, что микрофон не используется другим приложением

### Ошибки Vosk

**Модель Vosk не найдена:**

1. Убедитесь, что модель скачана и распакована в `models/vosk-ru`
2. Проверьте путь в `.env`: `VOSK_MODEL_PATH=models/vosk-ru`
3. Запустите проверку: `python scripts/check_voice_system.py`

**Hotword не срабатывает:**

1. Проверьте работу Vosk: `python -m scripts.test_vosk_mic`
2. Убедитесь, что произносите «Ким» чётко
3. Проверьте настройки адаптивного порога: `HOTWORD_ADAPTIVE_THRESHOLD=1` в `.env`
4. При необходимости снизьте порог уверенности в коде

### Лимиты токенов

**Превышен дневной лимит токенов:**

- Лимит сбрасывается автоматически при смене даты
- Можно увеличить лимит через панель настроек или в `.env`: `TOKEN_BUDGET_DAILY=200000`
- В режиме `local_only` лимит не используется

**Как проверить использование токенов:**

- Информация о токенах выводится в логах при каждом запросе к LLM
- В панели настроек можно настроить дневной лимит

### Другие проблемы

**Telegram-бот не запускается:**

1. Проверьте, сохранён ли `BOT_TOKEN` в keyring: `python scripts/set_secrets.py`
2. Убедитесь, что токен корректный (получить у [@BotFather](https://t.me/BotFather))

**Нечитаемые символы в логах (Windows):**

- Используйте PowerShell скрипт: `.\run_voice_utf8.ps1`
- Или настройте кодировку PowerShell вручную

**OPENROUTER_API_KEY не установлен:**

1. Получите API-ключ на https://openrouter.ai
2. Сохраните в keyring: `python scripts/set_secrets.py`
3. Или используйте локальный режим: `LOCAL_ONLY=1` в `.env`

## Security-заметки

### Хранение секретов

- **Секреты хранятся в Windows Credential Manager**, а не в файлах `.env`
- При первом запуске секреты из переменных окружения автоматически сохраняются в keyring и удаляются из процесса
- Никогда не коммитьте файлы `.env` с секретами в репозиторий

### Доступ к файлам

- Доступ к файлам строго ограничен белым списком директорий (`FILE_WHITELIST_DIRS`)
- Все попытки доступа к файлам логируются
- Используется защита от path traversal атак

### Приватность

- В режиме `local_only` ассистент не обращается к LLM и не отправляет данные в интернет
- Голосовые данные обрабатываются локально через Vosk
- Telegram-бот хранит контекст диалога только в памяти (при перезапуске очищается)

### Рекомендации

- Регулярно проверяйте логи на наличие подозрительной активности
- Используйте режим `local_only` для максимальной приватности
- Настройте белый список директорий для работы с файлами
- Не передавайте токены и ключи третьим лицам
