# ИИ-ассистент «Ким»

Персональный ассистент в двух режимах:
- Локальный голосовой ассистент для Windows
- Приватный Telegram-бот

## Возможности MVP (Stage 1)

Текущая версия включает:

1. **Telegram-бот с LLM**
   - Диалог с контекстом (запоминает историю разговора)
   - Автоматический выбор модели (быстрая/умная) на основе триггеров
   - Управление дневным лимитом токенов
   - Обработка ошибок с понятными сообщениями

2. **Голосовой ассистент (Windows)**
   - Hotword «Ким» для активации
   - Распознавание речи (STT) через Vosk
   - Синтез речи (TTS) через Windows SAPI
   - Интеграция с LLM для ответов
   - Мягкое подтверждение фразы (только при необходимости)
   - Адаптивный порог для hotword
   - Опциональное шумоподавление (WebRTC VAD)

3. **Диагностика ПК**
   - Мониторинг CPU, RAM, диска, температуры
   - Уведомления в Telegram при превышении порогов
   - Голосовые уведомления (опционально)

## Структура проекта

```
/src
  /kim_core      - ядро ассистента (конфиг, LLM, промпты, логирование)
  /kim_voice     - голосовая часть (hotword, STT, TTS)
  /kim_telegram  - Telegram-бот
  /kim_scheduler - планировщик (Stage 2)
  /kim_desktop   - взаимодействие с ПК (Stage 2)
  /kim_settings_panel - панель настроек (Stage 2)
/tests           - тесты
/scripts         - утилиты
/docs            - документация
```

## Быстрый старт

### Установка

1. Установите Python 3.10+
2. Скопируйте `.env.example` в `.env` и заполните переменные
3. Установите зависимости:

```bash
make install
```

или вручную:

```bash
pip install -r requirements.txt
```

### Запуск компонентов

Все компоненты можно запустить через Makefile:

```bash
make bot      # Запуск Telegram-бота
make voice    # Запуск голосового ассистента
make diag     # Запуск сервиса диагностики
make test     # Запуск тестов
make help     # Справка по командам
```

Или используйте скрипты запуска напрямую:

```bash
python -m scripts.run_telegram_bot
python -m scripts.run_voice_assistant
python -m scripts.run_diagnostics_service
```

### Тестирование

Для запуска тестов:

```bash
make test
```

или

```bash
pytest tests/ -v
```

Подробнее о тестировании голосового ассистента см. раздел «Как тестировать голосовой ассистент» ниже.

## Конфигурация

Конфигурация приложения загружается из файла `.env` в корне проекта.

### Основные переменные окружения

- `MODE` — режим работы (`dev` или `prod`). По умолчанию: `dev`
- `LOG_LEVEL` — уровень логирования (`DEBUG`, `INFO`, `WARNING`, `ERROR`). По умолчанию: `INFO`
- `OPENROUTER_API_KEY` — API-ключ для OpenRouter (обязателен в режиме `prod`)
- `BOT_TOKEN` — токен Telegram-бота (обязателен в режиме `prod`)
- `MODEL_FAST` — быстрая модель LLM. По умолчанию: `openai/gpt-3.5-turbo`
- `MODEL_SMART` — умная модель LLM для сложных задач. По умолчанию: `openai/gpt-4-turbo`
- `TOKEN_BUDGET_DAILY` — дневной лимит токенов. По умолчанию: `50000`
- `LOCAL_ONLY` — режим только локально (`0` или `1`). Если `1`, ассистент не обращается к LLM и даёт только локальные голосовые ответы. По умолчанию: `0`
- `CPU_WARN` — порог предупреждения для загрузки CPU (в процентах). По умолчанию: `85`
- `RAM_WARN` — порог предупреждения для использования RAM (в процентах). По умолчанию: `90`
- `DISK_WARN` — порог предупреждения для использования диска (в процентах). По умолчанию: `90`
- `TEMP_WARN` — порог предупреждения для температуры (в градусах Цельсия). По умолчанию: не задан
- `DIAGNOSTICS_INTERVAL_SECONDS` — интервал проверки диагностики в секундах. По умолчанию: `60`
- `ALERTS_CHAT_ID` — ID чата/пользователя Telegram для отправки уведомлений о проблемах системы. По умолчанию: не задан

В режиме `prod` приложение проверяет наличие обязательных переменных (`OPENROUTER_API_KEY` и `BOT_TOKEN`) и выдаёт ошибку при их отсутствии.

## Интеграция с OpenRouter

Проект использует OpenRouter API для работы с LLM-моделями через два основных компонента:

### OpenRouterClient

Асинхронный клиент для взаимодействия с OpenRouter API. Обрабатывает запросы, ошибки сети и парсит ответы с информацией об использовании токенов.

### LLMRouter

Маршрутизатор моделей, который:

- **Автоматически выбирает модель** на основе контекста запроса:
  - По умолчанию использует быструю модель (`MODEL_FAST`)
  - Переключается на умную модель (`MODEL_SMART`) при обнаружении триггеров

- **Управляет дневным лимитом токенов** (`TOKEN_BUDGET_DAILY`):
  - Отслеживает использование токенов за день
  - Автоматически сбрасывает счётчик при смене даты
  - Блокирует запросы при превышении лимита

### Триггеры для умной модели

Для переключения на более мощную модель используйте в запросе одну из фраз:

- «реши это GPT-5»
- «режим качества»
- «нужен максимальный анализ»

Триггерные фразы автоматически удаляются из сообщения перед отправкой в LLM.

## Запуск Telegram-бота

### Подготовка

1. Создайте файл `.env` на основе `.env.example`:
   ```bash
   cp .env.example .env
   ```

2. Заполните обязательные переменные в `.env`:
   - `BOT_TOKEN` — токен вашего Telegram-бота (получите у [@BotFather](https://t.me/BotFather))
   - `OPENROUTER_API_KEY` — ваш API-ключ OpenRouter

3. Установите зависимости (если ещё не установлены):
   ```bash
   pip install -r requirements.txt
   ```

### Запуск

#### Вариант 1: Через Makefile (рекомендуется)

```bash
make bot
```

#### Вариант 2: Через скрипт запуска

```bash
python -m scripts.run_telegram_bot
```

#### Вариант 3: Прямой запуск модуля

```bash
python run_bot.py
```

или

```bash
cd src && python -m kim_telegram.main
```

### Использование

После запуска бот будет отвечать на сообщения в Telegram:

- **`/start`** — приветственное сообщение от Ким
- **`/help`** — показать список всех доступных команд
- **`/reset`** — очистка контекста диалога (начать разговор заново)
- **`/myid`** — показывает ваш Chat ID (для настройки уведомлений диагностики)
- **Обычное сообщение** — отправляется в LLM, учитывается контекст всей переписки

Бот автоматически:
- Сохраняет контекст диалога для каждого пользователя
- Выбирает модель (быструю или умную) на основе триггеров
- Отслеживает дневной лимит токенов
- Обрабатывает ошибки и уведомляет пользователя

### Примеры триггеров для умной модели

Для переключения на более мощную модель используйте в сообщении:
- «реши это GPT-5»
- «режим качества»
- «нужен максимальный анализ»

## Голосовой ассистент (локально, Windows)

Голосовой ассистент работает локально на Windows и активируется по ключевому слову «Ким».

### Требования

1. **Модель Vosk** для распознавания речи (см. раздел «Установка модели Vosk» ниже)
2. **Микрофон** должен быть подключён и настроен в Windows
3. **API ключ OpenRouter** для работы с LLM:
   - Укажите `OPENROUTER_API_KEY` в файле `.env`
   - Убедитесь, что на балансе есть средства

### Установка модели Vosk

**Важно:** Для работы голосового ассистента необходимо установить модель Vosk для распознавания речи.

1. **Скачайте модель Vosk:**
   - Перейдите на https://alphacephei.com/vosk/models
   - Для русского языка рекомендуем скачать одну из моделей:
     - `vosk-model-small-ru-0.22` (≈45 МБ) — быстрая, но менее точная
     - `vosk-model-ru-0.42` (≈1.8 ГБ) — более точная (рекомендуется)
     - `vosk-model-ru-0.22` (≈1.5 ГБ) — хороший баланс

2. **Распакуйте модель:**
   - Создайте папку `models` в корне проекта (если её нет)
   - Распакуйте скачанную модель так, чтобы структура была:
     ```
     models/
       vosk-ru/
         am/
         graph/
         ivector/
         ...
     ```
   - Имя папки `vosk-ru` может быть любым, но должно соответствовать пути в `.env`

3. **Настройте путь в `.env`:**
   ```env
   VOSK_MODEL_PATH=models/vosk-ru
   ```
   
   Или укажите полный путь к модели, если она находится в другом месте:
   ```env
   VOSK_MODEL_PATH=C:/path/to/vosk-model-ru-0.42
   ```

4. **Проверьте установку:**
   ```bash
   python scripts/check_voice_system.py
   ```
   
   Скрипт покажет, найдена ли модель и корректна ли её структура.

### Настройка

1. Убедитесь, что установлены все зависимости:
   ```bash
   pip install -r requirements.txt
   ```

### Запуск

#### Вариант 1: Через Makefile (рекомендуется)

```bash
make voice
```

#### Вариант 2: Через скрипт запуска

```bash
python -m scripts.run_voice_assistant
```

#### Вариант 3: Использование PowerShell скрипта (для Windows с UTF-8)

Для корректного отображения русских символов в логах:

```powershell
.\run_voice_utf8.ps1
```

#### Вариант 4: Прямой запуск модуля

```bash
python run_voice.py
```

или

```bash
python -m src.kim_voice.main
```

**Примечание:** Для корректного отображения русских символов в Windows PowerShell рекомендуется использовать Вариант 3 или настроить кодировку вручную.

### Диагностика Vosk

Если hotword «Ким» не срабатывает или вы подозреваете проблемы с распознаванием речи,
можно отдельно протестировать связку **Vosk + микрофон** без hotword-логики.

Запустите тестовый скрипт:

```bash
python -m scripts.test_vosk_mic
```

При запуске:

- загружается модель Vosk, указанная в `VOSK_MODEL_PATH` или `models/vosk-ru`,
- открывается микрофон,
- в течение ~15 секунд аудио с микрофона передаётся в Vosk.

Ожидаемое поведение:

- при разговоре в микрофон в **stdout** и в логах вы увидите:
  - строки вида `[PARTIAL] ...` — промежуточные (partial) результаты Vosk,
  - строки вида `[FINAL] ...` — финальные (final) результаты Vosk.
- если partial/final результатов нет вообще — проблема, скорее всего, в:
  - доступе к микрофону,
  - установке/пути к модели Vosk,
  - окружении аудиодрайверов.

Этот тест позволяет быстро отделить проблемы Vosk/микрофона от логики hotword и ассистента.

### Как тестировать голосовой ассистент

Для систематического тестирования голосового ассистента после улучшений STT/hotword существует детальный план тестирования. Он включает проверку качества распознавания, стабильности hotword, адаптивного порога, VAD и UX подтверждения.

**Основные команды для тестирования:**

```bash
# Тест Vosk + микрофон (базовая проверка)
python -m scripts.test_vosk_mic

# Тест STT (распознавание одной фразы с фильтрами)
python -m scripts.test_stt_once

# Полный голосовой ассистент
python run_voice_utf8.ps1
```

**Подробный план тестирования** находится в файле [`docs/voice_testing_plan.md`](docs/voice_testing_plan.md). План включает:

- Базовый тест Vosk + микрофон
- Тест STT с фильтрами длины и уверенности
- Тест hotword без LLM (LOCAL_ONLY=1)
- Тест полного конвейера (hotword → STT → LLM → TTS)
- Тест адаптивного порога (шумная vs тихая среда)
- Тест VAD (если включён)
- Тест UX подтверждения фразы
- Регрессионное тестирование

Каждый тест содержит описание цели, подготовку, команды запуска, ожидаемое поведение и рекомендации.

### Голосовой диалог с LLM

После активации по ключевому слову «Ким» ассистент:

1. **Отвечает голосом:** «Да, слушаю.»
2. **Слушает вопрос** пользователя через микрофон (с автоматическими повторами при неудачном распознавании)
3. **Подтверждает распознанную фразу:** «Вы сказали: [фраза]. Верно?»
4. **Слушает подтверждение** пользователя («да»/«нет»)
5. **Если пользователь сказал «нет»:** просит повторить фразу заново
6. **После подтверждения:**
   - Если `LOCAL_ONLY=0`: отправляет вопрос в LLM через OpenRouter
   - Если `LOCAL_ONLY=1`: даёт локальный ответ (без обращения к интернету)
7. **Озвучивает ответ** голосом (TTS)

**Пример использования:**
- Пользователь: «Ким» (hotword активирован)
- Ассистент: «Да, слушаю.» (голосом)
- Пользователь: «Расскажи кратко новости за сегодня» (голосом)
- Ассистент: Озвучивает ответ, полученный от LLM (без подтверждения, если уверенность высокая)

### Настройка качества распознавания речи

Ассистент поддерживает несколько настроек для улучшения качества распознавания речи и снижения ложных срабатываний:

#### Фильтры по длине фразы и уверенности (STT)

- **`min_phrase_chars`** (в коде) — минимальная длина распознанной фразы в символах (по умолчанию: 5)
- **`min_avg_confidence`** (в коде) — минимальная средняя уверенность по словам (по умолчанию: 0.6)
- Короткие фразы и фразы с низкой уверенностью автоматически отфильтровываются

#### Адаптивный порог для hotword

Hotword использует адаптивный порог уверенности, который автоматически подстраивается под уровень шума:
- В тихой обстановке требуется более высокая уверенность
- В шумной обстановке порог немного снижается для сохранения чувствительности
- Настраивается через переменную окружения `HOTWORD_ADAPTIVE_THRESHOLD` (по умолчанию: `1` - включён)

#### Мягкое подтверждение фразы

Подтверждение распознанной фразы запрашивается только в следующих случаях:
- Низкая уверенность распознавания (< 0.75)
- Длинная фраза (≥ 25 символов)

Для коротких фраз с высокой уверенностью подтверждение не требуется — ассистент сразу обрабатывает запрос.

#### WebRTC VAD (опционально)

Для улучшения качества распознавания можно включить WebRTC VAD (Voice Activity Detection), который отсекает фоновый шум:

1. **Установите библиотеку:**
   ```bash
   pip install webrtcvad
   ```

2. **Включите в `.env`:**
   ```env
   STT_USE_VAD=1
   STT_VAD_AGGRESSIVENESS=2
   ```
   - `STT_USE_VAD` — включить/выключить VAD (`0` или `1`, по умолчанию: `0`)
   - `STT_VAD_AGGRESSIVENESS` — агрессивность (0-3, где 3 — самая агрессивная, по умолчанию: `2`)

**Важно:** VAD работает только при частоте дискретизации 8, 16 или 32 кГц. Проект не сломается, если библиотека `webrtcvad` не установлена — VAD просто не будет использоваться.

#### Настройки микрофона

Вы можете явно указать устройство ввода и параметры микрофона:

```env
MIC_DEVICE_INDEX=
MIC_SAMPLE_RATE=16000
MIC_CHUNK_SIZE=4000
```

- **`MIC_DEVICE_INDEX`** — индекс устройства ввода (микрофон). Если не указан, используется устройство по умолчанию
- **`MIC_SAMPLE_RATE`** — частота дискретизации (по умолчанию: `16000` Гц)
- **`MIC_CHUNK_SIZE`** — размер блока аудио (по умолчанию: `4000` сэмплов)

**Как узнать индекс устройства:**
```python
import sounddevice as sd
print(sd.query_devices())
```

### Поведение

После запуска ассистент:
- Начинает прослушивать микрофон для поиска ключевого слова «Ким»
- При обнаружении слова «Ким»:
  - Отвечает голосом: «Да, слушаю.»
  - Переходит в режим прослушивания вопроса
  - При неудачном распознавании делает до 2 повторных попыток
  - После распознавания подтверждает фразу голосом и спрашивает, верно ли она поняла
  - При подтверждении отправляет вопрос в LLM (если не включён режим `LOCAL_ONLY`)
  - Озвучивает ответ от LLM или локальный ответ
- Использует антидребезг (не срабатывает чаще раза в 1.2 секунды)

Для остановки нажмите `Ctrl+C`.

### Улучшения UX

#### Подтверждение команды

Ким повторяет распознанную фразу и спрашивает, верно ли она поняла. Это помогает:
- Убедиться, что команда распознана правильно
- Исправить ошибку распознавания, если что-то пошло не так

**Пример:**
- Пользователь: «Какой сегодня день?»
- Ассистент: «Вы сказали: Какой сегодня день? Верно?»
- Пользователь: «Да» → продолжает выполнение
- Пользователь: «Нет» → просит повторить

#### Повторы

При плохом распознавании речи (тишина, неразборчиво) Ким делает до 2 автоматических повторных попыток распознать фразу. Это повышает надёжность работы в шумной обстановке.

**Пример:**
- Попытка 1: ничего не распознано
- Попытка 2: ничего не распознано
- Попытка 3: фраза распознана успешно

Если все попытки неудачны, Ким сообщает: «Не расслышала, повторите позже.»

#### Режим только локально

Если в `.env` установлено `LOCAL_ONLY=1`, Ким работает без обращения к LLM и даёт только локальные ответы:

- Приветствие: «Привет! Сейчас я работаю в локальном режиме и не обращаюсь к интернету.»
- Запрос времени: сообщает текущее время (если в фразе есть слова «время», «который час»)
- Остальные запросы: «Сейчас включён режим только локально, я не обращаюсь к ИИ-модели.»

Этот режим полезен для:
- Тестирования голосового интерфейса без затрат на API
- Работы в условиях отсутствия интернета
- Повышения приватности (данные не отправляются в облако)

### Настройка TTS

Параметры голоса можно изменить в коде `src/kim_voice/tts/voice.py`:
- Скорость речи (по умолчанию: 170 слов/минуту)
- Громкость (по умолчанию: 1.0)
- Выбор женского голоса выполняется автоматически, если доступен

### Настройка качества распознавания

Система использует фильтрацию для повышения качества распознавания речи и снижения ложных срабатываний hotword.

**Важно:** Hotword и STT — это разные этапы работы ассистента:

- **Hotword (детекция «Ким»)** — работает постоянно, ищет короткое слово "Ким" (3 символа) и имеет свои настройки фильтрации (`min_chars_in_utterance = 3`)
- **STT (распознавание вопроса)** — используется ПОСЛЕ активации hotword для распознавания полного вопроса пользователя (обычно длиннее 5 символов)
- **STT (подтверждение)** — используется для коротких ответов "да"/"нет" и имеет специальные мягкие критерии

Поэтому параметр `min_phrase_chars = 5` для STT не конфликтует с hotword "Ким" (3 символа) — это разные этапы работы системы.

#### STT (Распознавание речи)

Для улучшения качества распознавания применяются следующие фильтры:

- **Минимальная длина фразы** (`min_phrase_chars = 5`) — слишком короткие фразы (менее 5 символов) отклоняются как некачественные. Это применяется для распознавания вопросов пользователя.
- **Минимальная средняя уверенность** (`min_avg_confidence = 0.6`) — фразы с низкой уверенностью распознавания (средняя уверенность по словам < 0.6) отклоняются

**Для коротких подтверждений** ("да"/"нет") используется специальный метод `listen_once_for_confirmation()` с более мягкими критериями:
- Минимальная длина: 2 символа (подходит для "да", "нет")
- Минимальная уверенность: 0.5 (ниже, чем для обычных фраз)
- Более короткий таймаут тишины: 1 секунда (вместо 1.5)

Это позволяет корректно распознавать короткие ответы пользователя.

Эти параметры настраиваются в `STTConfig` в файле `src/kim_voice/stt/speech_to_text.py`:

```python
@dataclass
class STTConfig:
    min_phrase_chars: int = 5  # минимальная длина фразы в символах
    min_avg_confidence: float = 0.6  # минимальная средняя уверенность
    debug_log_words: bool = False  # логирование слов с уверенностью
```

Если в вашей среде много шума, можно:
- Увеличить `min_avg_confidence` (например, до `0.7` или `0.8`) для более строгой фильтрации
- Увеличить `min_phrase_chars` (например, до `7`), чтобы игнорировать очень короткие фразы

#### Hotword (Ключевое слово «Ким»)

Для снижения ложных срабатываний hotword применяются:

- **Строгое совпадение слова** (`require_strict_word_match = True`) — hotword срабатывает только если найдено отдельное слово "ким", а не подстрока
- **Минимальная длина фразы** (`min_chars_in_utterance = 3`) — слишком короткие фразы игнорируются
- **Минимальная средняя уверенность** (`min_hotword_confidence = 0.7`) — низкая уверенность распознавания приводит к игнорированию

Эти параметры настраиваются в `HotwordConfig` в файле `src/kim_voice/hotword/kim_hotword.py`:

```python
@dataclass
class HotwordConfig:
    min_hotword_confidence: float = 0.7  # минимальная средняя уверенность
    require_strict_word_match: bool = True  # строгое совпадение слова
    min_chars_in_utterance: int = 3  # минимальная длина фразы
```

Если hotword срабатывает слишком часто:
- Увеличьте `min_hotword_confidence` (например, до `0.8` или `0.85`)
- Убедитесь, что `require_strict_word_match = True` включено

Если hotword не срабатывает:
- Незначительно снизьте `min_hotword_confidence` (например, до `0.65`)
- Проверьте, что микрофон работает корректно

### Отладка

Для проверки работы:
1. Убедитесь, что модель Vosk загружена (проверьте логи при запуске)
2. Проверьте, что микрофон работает (Windows → Параметры → Система → Звук)
3. В логах будут видны все распознанные фразы и срабатывания hotword

## Диагностика ПК и оповещения

Ассистент «Ким» может отслеживать состояние вашего компьютера и уведомлять о проблемах с ресурсами системы.

### Собираемые метрики

Сервис диагностики собирает следующие метрики:

- **CPU (процессор)** — процент использования процессора
- **RAM (память)** — процент использования оперативной памяти
- **Диск** — процент использования дискового пространства
- **Температура** — температура процессора (если доступна на вашей платформе)

### Пороги предупреждений

По умолчанию предупреждения отправляются при:

- Загрузка CPU ≥ 85%
- Использование RAM ≥ 90%
- Использование диска ≥ 90%
- Температура — настраивается вручную (по умолчанию не задана)

Вы можете настроить пороги в файле `.env`:

```env
CPU_WARN=85
RAM_WARN=90
DISK_WARN=90
TEMP_WARN=80
```

Если порог не задан (например, `TEMP_WARN=`), предупреждения по этой метрике отправляться не будут.

### Настройка уведомлений

Для получения уведомлений в Telegram необходимо указать:

1. **`ALERTS_CHAT_ID`** — ID вашего чата/пользователя в Telegram

   **Самый простой способ получить ID:**
   
   - Запустите вашего бота (если ещё не запущен): `python run_bot.py`
   - Отправьте боту команду: ` /myid`
   - Бот вернёт ваш Chat ID (например, `123456789`)
   - Добавьте этот ID в файл `.env`:
     ```env
     ALERTS_CHAT_ID=123456789
     ```

   **Альтернативные способы:**
   
   - Через бота [@userinfobot](https://t.me/userinfobot): напишите `/start`, бот вернёт ваш ID
   - Через бота [@RawDataBot](https://t.me/RawDataBot): отправьте сообщение, бот вернёт JSON с ID
   - Через скрипт: запустите `python scripts/get_chat_id.py` для подробных инструкций

2. **`BOT_TOKEN`** — токен вашего Telegram-бота (должен быть уже указан)

3. **`DIAGNOSTICS_INTERVAL_SECONDS`** — интервал проверки в секундах (по умолчанию: 60)

```env
ALERTS_CHAT_ID=123456789
DIAGNOSTICS_INTERVAL_SECONDS=60
```

### Запуск сервиса диагностики

#### Вариант 1: Через Makefile

```bash
make diag
```

#### Вариант 2: Через скрипт запуска

```bash
python -m scripts.run_diagnostics_service
```

#### Вариант 3: Прямой запуск модуля

```bash
python -m src.kim_scheduler.diagnostics_watcher
```

### Поведение сервиса

После запуска сервис:

1. **Проверяет метрики** каждые N секунд (по умолчанию 60)
2. **Сравнивает** значения с порогами
3. **При превышении порогов:**
   - Отправляет уведомление в Telegram с подробностями проблем
   - Если голосовой ассистент запущен локально (Windows), произносит голосовое предупреждение: *"Внимание, обнаружены проблемы с ресурсами компьютера. Я отправила подробности в Telegram."*

**Пример уведомления в Telegram:**

```
⚠️ Диагностика ПК: обнаружены проблемы:

• Высокая загрузка CPU: 92.5% (порог: 85%)
• Мало свободной оперативной памяти: 95.2% используется (порог: 90%)
```

### Голосовые уведомления

Голосовые уведомления доступны автоматически, если:

- Сервис запущен на Windows
- Модуль `kim_voice` доступен
- Синтезатор речи (TTS) инициализирован успешно

Если голосовые уведомления недоступны, сервис продолжит работу и будет отправлять только Telegram-уведомления.

### Особенности температуры

Поддержка температуры зависит от:

- **Платформы** (Windows/Linux/macOS)
- **Доступности сенсоров** в системе
- **Возможностей библиотеки psutil**

Если температура недоступна, сервис продолжит работу, собирая остальные метрики.

### Остановка сервиса

Для остановки сервиса нажмите `Ctrl+C`. Сервис корректно завершит работу и закроет все ресурсы.

## Тестирование

### Unit-тесты

Для запуска unit-тестов:

```bash
make test
```

или

```bash
pytest tests/ -v
```

Доступные тесты:
- `tests/test_config.py` — тесты конфигурации (валидация, режимы)
- `tests/test_llm_router.py` — тесты маршрутизатора LLM (выбор модели, лимиты)
- `tests/test_system_diagnostics.py` — тесты диагностики системы (метрики, пороги)

### Тестирование голосового ассистента

Подробный план тестирования голосового ассистента находится в [`docs/voice_testing_plan.md`](docs/voice_testing_plan.md). План включает тесты для:
- Базовой работы Vosk + микрофон
- STT с фильтрами
- Hotword без ложных срабатываний
- Полного конвейера (hotword → STT → LLM → TTS)
- Адаптивного порога
- VAD (если включён)
- UX подтверждения фразы

## Диагностика проблем

### Типичные проблемы и решения

#### Проблема: Модель Vosk не найдена

**Решение:**
1. Убедитесь, что модель скачана и распакована в папку `models/vosk-ru`
2. Проверьте путь в `.env`: `VOSK_MODEL_PATH=models/vosk-ru`
3. Запустите проверку: `python scripts/check_voice_system.py`

#### Проблема: Нет доступа к микрофону

**Решение:**
1. Проверьте настройки микрофона в Windows
2. Убедитесь, что микрофон включён в настройках приватности Windows
3. Попробуйте указать индекс устройства: `MIC_DEVICE_INDEX=1` (узнать индекс: `python -c "import sounddevice as sd; print(sd.query_devices())"`)

#### Проблема: OPENROUTER_API_KEY не установлен

**Решение:**
1. Получите API-ключ на https://openrouter.ai
2. Добавьте в `.env`: `OPENROUTER_API_KEY=your-key-here`
3. Или используйте локальный режим: `LOCAL_ONLY=1`

#### Проблема: Telegram-бот не запускается

**Решение:**
1. Проверьте `BOT_TOKEN` в `.env` (получить у [@BotFather](https://t.me/BotFather))
2. Убедитесь, что токен корректный и бот создан
3. Проверьте режим: в `prod` требуются и `BOT_TOKEN`, и `OPENROUTER_API_KEY`

#### Проблема: Hotword не срабатывает

**Решение:**
1. Проверьте работу Vosk: `python -m scripts.test_vosk_mic`
2. Убедитесь, что произносите «Ким» чётко
3. Проверьте настройки адаптивного порога: `HOTWORD_ADAPTIVE_THRESHOLD=1`
4. При необходимости снизьте порог уверенности в коде

#### Проблема: Нечитаемые символы в логах (Windows)

**Решение:**
1. Используйте скрипт `run_voice_utf8.ps1` для запуска
2. Или настройте кодировку PowerShell вручную (см. раздел «Запуск голосового ассистента»)

### Дополнительная диагностика

Для проверки системы используйте:

```bash
python scripts/check_voice_system.py  # Проверка голосовой системы
python scripts/check_config.py        # Проверка конфигурации
python scripts/system_check.py        # Общая проверка системы
```