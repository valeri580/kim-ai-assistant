# План тестирования голосового ассистента «Ким»

Данный документ описывает систематический подход к тестированию голосового ассистента после улучшений STT/hotword. План включает серию тестов для проверки качества распознавания, стабильности hotword, адаптивного порога, VAD и UX подтверждения фраз.

---

## 1. Базовый тест Vosk + микрофон

### Цель теста
Проверить базовую работу Vosk распознавателя речи и микрофона без логики hotword. Этот тест позволяет отделить проблемы Vosk/микрофона от логики hotword и ассистента.

### Подготовка
- `VOSK_MODEL_PATH` должен быть корректно установлен в `.env` или модель должна находиться по пути `models/vosk-ru`
- Микрофон подключён и настроен в Windows
- `LOG_LEVEL=DEBUG` (опционально, для детального логирования)

### Команда запуска
```bash
python -m scripts.test_vosk_mic
```

### Что делать голосом
Произносите различные фразы на русском языке в течение ~15 секунд:
- "Привет"
- "Как дела"
- "Ким"
- "Расскажи анекдот"
- Любые другие фразы

### Ожидаемое поведение
- В консоли и логах отображаются:
  - `[PARTIAL] ...` — промежуточные (partial) результаты Vosk во время произнесения
  - `[FINAL] ...` — финальные (final) результаты Vosk после паузы
- Если partial/final результатов нет вообще — проблема в:
  - доступе к микрофону
  - установке/пути к модели Vosk
  - окружении аудиодрайверов

### На что обратить внимание
- Время отклика распознавания (задержка между речью и результатом)
- Качество распознавания (корректность текста)
- Появление partial результатов (показывает, что Vosk работает в реальном времени)
- Частота появления final результатов (должны появляться после пауз в речи)

---

## 2. Тест STT (распознавание одной фразы)

### Цель теста
Проверить работу модуля STT с фильтрами по длине фразы и уверенности. Тест использует тот же код, что и основной ассистент, но только для одной фразы.

### Подготовка
- `LOG_LEVEL=DEBUG` (рекомендуется)
- `VOSK_MODEL_PATH` корректно задан
- `STT_USE_VAD=0` или `STT_USE_VAD=1` (в зависимости от тестируемого сценария)

### Команда запуска
```bash
python -m scripts.test_stt_once
```

### Что делать голосом
После запуска скрипт попросит произнести одну фразу. Примеры фраз для тестирования:
- **Короткая, чёткая:** "Привет, Ким"
- **Средняя:** "Расскажи анекдот"
- **Длинная:** "Ким, сделай мне напоминание на завтра в восемь утра"
- **Короткая, шумная/шёпотом:** (для проверки фильтров уверенности)

### Ожидаемое поведение
- Скрипт выводит текущие настройки STT:
  - `min_phrase_chars`
  - `min_avg_confidence`
  - `use_vad`
  - другие параметры
- После произнесения фразы:
  - В stdout и логах отображается финальный распознанный текст
  - Выводится `avg_conf` (средняя уверенность по словам)
  - Если фраза прошла фильтры — показывается успешный результат
  - Если результат `None` — явно указывается, что фраза не прошла фильтры (слишком короткая или низкая уверенность)

### На что обратить внимание
- **Короткие фразы (меньше `min_phrase_chars`):** должны отфильтровываться с сообщением в логах
- **Фразы с низкой уверенностью:** должны отфильтровываться, если `avg_conf < min_avg_confidence`
- **Шумные фразы:** при включённом VAD должны фильтроваться шумовые чанки (в логах будет "STT: VAD считает, что это тишина/шум")
- **Нормальные фразы:** должны успешно распознаваться и проходить все фильтры

---

## 3. Тест hotword «Ким» без LLM

### Цель теста
Проверить стабильность детекции hotword «Ким», убедиться в отсутствии лавины ложных триггеров, протестировать адаптивный порог и фильтры.

### Подготовка
- `LOCAL_ONLY=1` (чтобы не тратить токены LLM)
- `LOG_LEVEL=DEBUG` (рекомендуется для детального анализа)
- `VOSK_MODEL_PATH` установлен
- `HOTWORD_ADAPTIVE_THRESHOLD=1` (или `0` для теста без адаптивного порога)

### Команда запуска
```bash
python run_voice_utf8.ps1
```
или
```bash
python run_voice.py
```

### Сценарии

#### Сценарий 3.1: Тишина (проверка на ложные срабатывания)
**Действия:** 
- Запустить ассистента
- Сидеть в тишине 1-2 минуты, не произнося ничего

**Ожидаемое поведение:**
- Нет TRIGGER firing в логах
- В логах могут появляться `Hotword: распознано text='...'` если что-то подхватывается шумом
- Но при этом `is_hotword=False` и TRIGGER не срабатывает
- Адаптивный порог (если включён) стабилизируется на уровне шума

**Что смотреть в логах:**
- `Hotword: распознано text='...', avg_conf=...`
- `Hotword: проверка слова -> is_hotword=False`
- `Hotword: adaptive threshold updated, noise_level=..., dynamic_conf_threshold=...` (если адаптивный порог включён)

#### Сценарий 3.2: Чёткое произнесение «Ким»
**Действия:**
- Произнести чётко «Ким» несколько раз (с паузами не менее 1.2 секунды между произнесениями)

**Ожидаемое поведение:**
- При каждом чётком «Ким» должен срабатывать TRIGGER
- В логах: `Hotword: TRIGGER fired text='ким', avg_conf=...`
- Ассистент отвечает: «Да, слушаю.»
- Запускается STT для прослушивания вопроса
- Даётся локальный ответ (так как `LOCAL_ONLY=1`)

**Что смотреть в логах:**
- `Hotword: распознано text='ким'`
- `Hotword: проверка слова -> is_hotword=True`
- `Hotword: TRIGGER fired ...`
- `STT: начинаю слушать фразу...`

#### Сценарий 3.3: Фразы без слова «Ким»
**Действия:**
- Произнести фразы, не содержащие слово «Ким»:
  - "Привет"
  - "Как дела"
  - "Компьютер"
  - "Кино"
  - "Кимба" (для проверки строгого совпадения)

**Ожидаемое поведение:**
- В логах виден распознанный текст
- `Hotword: проверка слова -> is_hotword=False`
- TRIGGER не срабатывает
- Ассистент не активируется

**Что смотреть в логах:**
- `Hotword: распознано text='привет'`
- `Hotword: проверка слова -> is_hotword=False`
- Отсутствие `Hotword: TRIGGER fired`

### На что обратить внимание
- **Debounce:** между срабатываниями должно пройти не менее `debounce_seconds` (1.2 сек по умолчанию)
- **Ложные срабатывания:** их должно быть минимум, особенно в тишине
- **Адаптивный порог:** должен корректно подстраиваться под уровень шума (если включён)

---

## 4. Тест полного голосового конвейера

### Цель теста
Проверить полный цикл работы ассистента: hotword → STT → LLM → TTS, включая мягкое подтверждение фразы.

### Подготовка
- `LOCAL_ONLY=0` (для работы с LLM)
- `OPENROUTER_API_KEY` задан и валиден
- Токены/лимиты в пределах (`TOKEN_BUDGET_DAILY` не исчерпан)
- `LOG_LEVEL=INFO` или `DEBUG`

### Команда запуска
```bash
python run_voice_utf8.ps1
```
или
```bash
python run_voice.py
```

### Сценарии

#### Сценарий 4.1: Короткий запрос (без подтверждения)
**Действия:**
1. Произнести: «Ким»
2. После ответа «Да, слушаю.» произнести: «Кто ты такая?»

**Ожидаемое поведение:**
- Hotword активируется
- Ассистент говорит: «Да, слушаю.»
- STT распознаёт: «Кто ты такая?»
- Если фраза короткая и уверенность высокая (`avg_conf >= 0.75` и длина < 25 символов):
  - Подтверждение может быть пропущено
  - Сразу отправляется запрос в LLM
  - В логах: `Подтверждение не требуется (уверенность=..., длина=...)`
- LLM отвечает
- TTS озвучивает ответ

**Что смотреть в логах:**
- `Hotword: TRIGGER fired`
- `STT: финальный текст='кто ты такая', avg_conf=...`
- `Подтверждение не требуется` или `Требуется подтверждение`
- `Отправка запроса в LLM...`
- Информация о выборе модели (fast/smart) и расходе токенов

#### Сценарий 4.2: Длинный запрос (с подтверждением)
**Действия:**
1. Произнести: «Ким»
2. После ответа «Да, слушаю.» произнести длинную фразу: «Придумай короткий тост на день рождения друга»

**Ожидаемое поведение:**
- Hotword активируется
- Ассистент говорит: «Да, слушаю.»
- STT распознаёт длинную фразу
- Если фраза длинная (≥ 25 символов) или уверенность низкая:
  - Ассистент говорит: «Кажется, вы сказали: [фраза]. Всё верно?»
  - Запускается прослушивание подтверждения
  - Пользователь отвечает «Да» или просто молчит
  - После подтверждения отправляется запрос в LLM
- LLM отвечает
- TTS озвучивает ответ

**Что смотреть в логах:**
- `Требуется подтверждение (уверенность=..., длина=...)`
- `STT: начинаю слушать подтверждение`
- `STT: подтверждение распознано='да'`
- `Отправка запроса в LLM...`

### На что обратить внимание
- Корректность работы мягкого подтверждения (пропуск для коротких/уверенных фраз)
- Качество распознавания длинных фраз
- Выбор модели LLM (fast vs smart)
- Расход токенов (должен логироваться)

---

## 5. Тест адаптивного порога

### Цель теста
Проверить работу адаптивного порога уверенности для hotword в различных условиях (тихая vs шумная среда).

### Подготовка
- `HOTWORD_ADAPTIVE_THRESHOLD=1` (адаптивный порог включён)
- `LOG_LEVEL=DEBUG` (для просмотра обновлений порога)
- `VOSK_MODEL_PATH` установлен

### Команда запуска
```bash
python run_voice_utf8.ps1
```

### Сценарии

#### Сценарий 5.1: Тихая комната
**Действия:**
- Найти тихое место
- Запустить ассистента
- Сидеть в тишине 1-2 минуты
- Периодически (раз в 10-15 секунд) произносить «Ким»

**Ожидаемое поведение:**
- Адаптивный порог стабилизируется на высоком уровне (ближе к `max_confidence_floor`)
- В логах регулярно появляются обновления: `Hotword: adaptive threshold updated, noise_level=..., dynamic_conf_threshold=...`
- При низком уровне шума `dynamic_conf_threshold` должен быть ближе к `max_confidence_floor` (0.9 по умолчанию)
- Ложные срабатывания должны быть минимальными

**Что смотреть в логах:**
- `Hotword: adaptive threshold updated, noise_level=..., dynamic_conf_threshold=...`
- Корреляция между `noise_level` (низкий) и `dynamic_conf_threshold` (высокий)
- Количество ложных срабатываний (должно быть мало)

#### Сценарий 5.2: Фоновый шум
**Действия:**
- Включить фоновый шум (музыка, разговоры, вентилятор)
- Запустить ассистента
- Периодически произносить «Ким»

**Ожидаемое поведение:**
- Адаптивный порог снижается (но остаётся в пределах `min_confidence_floor` - `max_confidence_floor`)
- В логах видно, что `noise_level` выше, а `dynamic_conf_threshold` ниже, чем в тихой комнате
- Hotword всё ещё должен срабатывать на чёткое «Ким», но не на чистый шум
- Число ложных срабатываний может немного увеличиться, но не должно быть лавинообразным

**Что смотреть в логах:**
- `Hotword: adaptive threshold updated, noise_level=..., dynamic_conf_threshold=...`
- Сравнение `noise_level` (высокий) и `dynamic_conf_threshold` (сниженный, но в пределах)
- Стабильность работы (нет лавины ложных срабатываний)

### На что обратить внимание
- **Диапазон порога:** должен оставаться в пределах `min_confidence_floor` (0.5) - `max_confidence_floor` (0.9)
- **Реактивность:** порог должен адаптироваться за разумное время (не мгновенно, но и не слишком долго)
- **Стабильность:** нет резких скачков порога

---

## 6. Тест VAD (Voice Activity Detection)

### Цель теста
Проверить работу опционального WebRTC VAD для фильтрации шума при распознавании речи.

### Подготовка
- `STT_USE_VAD=1` (VAD включён)
- `STT_VAD_AGGRESSIVENESS=2` (можно протестировать разные значения: 0, 1, 2, 3)
- `LOG_LEVEL=DEBUG` (для просмотра сообщений VAD)
- Библиотека `webrtcvad` установлена (если нет — будет предупреждение, но проект не сломается)

**Установка webrtcvad:**
```bash
pip install webrtcvad
```

### Команда запуска
```bash
python -m scripts.test_stt_once
```
или
```bash
python run_voice_utf8.ps1
```

### Сценарии

#### Сценарий 6.1: Речь vs тишина
**Действия:**
- Запустить тест STT или полный ассистент
- Во время прослушивания:
  - Сидеть в тишине несколько секунд
  - Затем произнести фразу
  - Снова сидеть в тишине

**Ожидаемое поведение:**
- В логах появляются сообщения: `STT: VAD считает, что это тишина/шум, пропускаем чанк` — во время тишины
- Во время речи таких сообщений должно быть меньше или вообще не быть
- Распознавание должно работать нормально, но часть шумовых чанков фильтруется

**Что смотреть в логах:**
- `STT: VAD считает, что это тишина/шум, пропускаем чанк` — частота появления во время тишины vs речи
- Общее качество распознавания (не должно сильно ухудшиться)

#### Сценарий 6.2: Речь vs фоновый шум
**Действия:**
- Включить фоновый шум (музыка, разговоры)
- Запустить тест STT
- Произнести фразу

**Ожидаемое поведение:**
- VAD должен фильтровать часть фонового шума
- Распознавание должно работать лучше, чем без VAD (меньше ложных слов из шума)
- В логах видно, что часть шумовых чанков пропускается

**Что смотреть в логах:**
- Частота сообщений `STT: VAD считает, что это тишина/шум`
- Качество финального распознанного текста (должно быть чище, без мусорных слов)

### На что обратить внимание
- **Агрессивность:** разные значения `STT_VAD_AGGRESSIVENESS` (0-3) дают разный баланс между фильтрацией шума и сохранением речи
- **Производительность:** VAD не должен заметно замедлять распознавание
- **Работа без VAD:** проект должен работать, даже если `webrtcvad` не установлен (VAD просто отключается)

---

## 7. Тест UX подтверждения фразы

### Цель теста
Проверить работу мягкого подтверждения: когда оно включается, когда пропускается, как работает повтор при отказе.

### Подготовка
- `LOCAL_ONLY=1` (чтобы не тратить токены LLM на тесты)
- `LOG_LEVEL=DEBUG` (для детального просмотра логики подтверждения)

### Команда запуска
```bash
python run_voice_utf8.ps1
```

### Сценарии

#### Сценарий 7.1: Короткая фраза, высокая уверенность (без подтверждения)
**Действия:**
1. Произнести: «Ким»
2. После ответа «Да, слушаю.» произнести чётко и коротко: «Привет»

**Ожидаемое поведение:**
- Hotword активируется
- Ассистент говорит: «Да, слушаю.»
- STT распознаёт: «Привет»
- Если `avg_conf >= 0.75` и длина < 25 символов:
  - Подтверждение пропускается
  - В логах: `Подтверждение не требуется (уверенность=..., длина=...)`
  - Сразу даётся локальный ответ (так как `LOCAL_ONLY=1`)

**Что смотреть в логах:**
- `STT: финальный текст='привет', avg_conf=...`
- `Подтверждение не требуется (уверенность=... >= 0.75, длина=... < 25)`
- Отсутствие фразы «Вы сказали: ... Верно?»

#### Сценарий 7.2: Длинная фраза или низкая уверенность (с подтверждением)
**Действия:**
1. Произнести: «Ким»
2. После ответа «Да, слушаю.» произнести длинную фразу или тихо/шёпотом: «Ким, сделай мне, пожалуйста, напоминание на завтра, чтобы я не забыл купить продукты»

**Ожидаемое поведение:**
- Hotword активируется
- Ассистент говорит: «Да, слушаю.»
- STT распознаёт фразу (или частично, если низкая уверенность)
- Если длина ≥ 25 символов или `avg_conf < 0.75`:
  - Ассистент говорит: «Кажется, вы сказали: [фраза]. Всё верно?»
  - В логах: `Требуется подтверждение (уверенность=... < 0.75 или длина=... >= 25)`
  - Запускается прослушивание подтверждения

**Что смотреть в логах:**
- `Требуется подтверждение (уверенность=... < 0.75 или длина=... >= 25)`
- `STT: начинаю слушать подтверждение`

#### Сценарий 7.3: Отказ от подтверждения (ответ «нет»)
**Действия:**
1. Произнести: «Ким»
2. После ответа «Да, слушаю.» произнести фразу (длинную или с низкой уверенностью)
3. Когда ассистент спросит «Всё верно?», ответить: «Нет»

**Ожидаемое поведение:**
- Ассистент повторяет распознанную фразу и спрашивает подтверждение
- Пользователь говорит «Нет»
- В логах: `Ответ на подтверждение: 'нет'`
- В логах: `Пользователь отклонил распознанную фразу, просим повторить`
- Ассистент говорит: «Хорошо, повторите, пожалуйста.»
- Запускается повторное прослушивание
- После второй попытки фраза обрабатывается (без повторного подтверждения)

**Что смотреть в логах:**
- `Ответ на подтверждение: 'нет'`
- `Пользователь отклонил распознанную фразу, просим повторить`
- `Повторно распознанная фраза: '...'`
- Вторая фраза обрабатывается без повторного подтверждения

### На что обратить внимание
- **Пороги:** подтверждение должно включаться при длине ≥ 25 символов ИЛИ `avg_conf < 0.75`
- **Повтор:** после отказа пользователя должна быть возможность повторить фразу
- **UX:** не должно быть слишком много подтверждений для коротких/чётких фраз

---

## 8. Регрессионное тестирование

### Цель
Проверить, что после изменений основные сценарии продолжают работать корректно.

### Чек-лист быстрой проверки

1. **Базовый hotword:**
   - [ ] «Ким» срабатывает стабильно
   - [ ] Нет лавины ложных срабатываний в тишине

2. **STT:**
   - [ ] Короткие фразы (< 5 символов) фильтруются
   - [ ] Фразы с низкой уверенностью фильтруются
   - [ ] Нормальные фразы распознаются корректно

3. **Полный конвейер:**
   - [ ] Hotword → STT → LLM → TTS работает
   - [ ] Мягкое подтверждение работает корректно

4. **Адаптивный порог (если включён):**
   - [ ] Порог адаптируется к уровню шума
   - [ ] Остаётся в разумных пределах

5. **VAD (если включён):**
   - [ ] Фильтрует шум без ухудшения распознавания речи

---

## Рекомендации по тестированию

1. **Начните с базовых тестов:** сначала убедитесь, что Vosk и микрофон работают (`test_vosk_mic`), затем переходите к более сложным сценариям.

2. **Используйте DEBUG логирование:** для детального анализа работы системы установите `LOG_LEVEL=DEBUG` в `.env`.

3. **Тестируйте в разных условиях:**
   - Тихая комната
   - С фоновым шумом
   - Разное расстояние от микрофона
   - Разная громкость голоса

4. **Документируйте проблемы:** если что-то работает не так, зафиксируйте:
   - Условия тестирования
   - Ожидаемое поведение
   - Фактическое поведение
   - Релевантные логи

5. **Периодическое тестирование:** рекомендуется проводить регрессионные тесты после значительных изменений в коде.

---

## Полезные команды

```bash
# Тест Vosk + микрофон
python -m scripts.test_vosk_mic

# Тест STT (одна фраза)
python -m scripts.test_stt_once

# Полный голосовой ассистент (LOCAL_ONLY=1 для тестов без LLM)
python run_voice_utf8.ps1

# Проверка системы (зависимости, модели, устройства)
python -m scripts.check_voice_system
```

---

*Документ создан для проекта «ИИ-ассистент Ким». Последнее обновление: после улучшений STT/hotword.*

